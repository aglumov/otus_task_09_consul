# Задание

Реализовать consul cluster который выдает доменное имя для веб портала.

Плавающий IP заменить на балансировку через DNS.

В случае умирания одного из веб серверов IP должен убираться из DNS.


# Подготовка к запуску

Публичный ключ должен находиться по пути: ```~/.ssh/id_rsa.pub```

В системе должны быть установлены ansible и terraform. Тестировалось на версиях:
* ansible [core 2.13.8]
  * community.mysql 3.6.0
* terraform v1.5.5

# Настройка и запуск

* склонировать репозиторий;
* настроить подключение к облаку яндекс. Для этого перейти в каталог ```terraform``` создать файл ```yc.auto.tfvars``` с содержимым (подставить свой токен, id облака и каталога):

```
yc_token     = токен
yc_cloud_id  = id облака
yc_folder_id = id каталога
```
В задании используется домен gloomail.ru, делегированный яндексу. Управление доменом выполняется через [Яндекс 360 REST API](https://yandex.ru/dev/api360/doc/concepts/intro.html).
Для этого необходимо настроить доступ к API: создать файл ```domain.auto.tfvars``` с содержимым (подставить свои данные):

```
domain_name  = домен
domain_org   = id организации в яндекс 360
domain_token = токен
```

* инициализировать терраформ: ```terraform init```;
* запустить создание инфраструктуры: ```terraform apply```;
* после создания инфраструктуры дождаться загрузки ВМ;
* перейти в каталог ```ansible``` и запустить плейбук: ```ansible-playbook setup.yaml```;
* при успешном выполнении плейбука в выводе terraform взять ip-адрес из ```nginx_public_ip_address``` и подключиться по http:
  * в основном location будет доступно приложение WordPress;
  * в location ```ui``` будет веб-интерфейс консула;

# Пояснения

Процесс развертывания окружения при помощи terraform и установка ПО при помощи ansible записал на видео, т.к. требуется очень много скриншотов, чтобы всё зафиксировать.

Видео доступно по ссылке: https://disk.yandex.ru/i/uiVW62zrFMaicg

* инфраструктура проекта взята из [задания 2](https://github.com/aglumov/otus_task_4_nginx) (Настраиваем балансировку веб-приложения):
  * ```lb0-1```: балансировщик (nginx);
  * ```app0-1```: сервера веб-приложения (Wordpress);
  * ```db0```: база данных веб-приложения (mariadb);
* Consul server устанавливается на ноды ```consul0-2```;
* Consul client устанавливается на ноды  ```lb0-1```, ```app0-1```;
* Consul template устанавливается на ноды ```lb0-1```;
* В Consul добавляются два сервиса:
  * balancer - следит за работоспособностью nginx на нодах ```lb0-1```:
    * при недоступности сервиса через вызов API удаляет A-запись с публичным ip-адресом соответствующего балансировщика;
  * wordpress - следит за работоспособностью nginx на нодах ```app0-1```:
    * при недоступности сервиса конфигурирует блок upstream в конфигурации nginx на ```lb0-1```.
